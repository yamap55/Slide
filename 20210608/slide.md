<style type="text/css">
  .reveal h1,
  .reveal h2,
  .reveal h3,
  .reveal h4,
  .reveal h5,
  .reveal h6 {
    text-transform: none;
  }
</style>

# システム設計勉強会第 4 回

---

## アジェンダ

- はじめに
- なぜソフトウェアの変更は大変なのか
- プログラムの変更が楽になる書き方
- 参考

---

## はじめに

--

<img src="./img/img01.png" style="width:40%;" alt="現場で役立つシステム設計の原則"/>

https://www.amazon.co.jp/dp/B073GSDBGT/

--

## 第 3 章 業務ロジックをわかりやすく整理する

- データとロジックを別のクラスに分けることがわかりにくさを生む
- データとロジックを一体にして業務ロジックを整理する
- 三層の関心毎と業務ロジックの分離を徹底する

---

## 第 3 章 業務ロジックをわかりやすく整理する

- → **データとロジックを別のクラスに分けることがわかりにくさを生む**
- データとロジックを一体にして業務ロジックを整理する
- 三層の関心毎と業務ロジックの分離を徹底する

---

## 業務アプリケーションのコードの見通しが悪くなる原因

--

### 昔からよくあるクラス設計

- 機能クラス
  - 注文登録クラス
    - 注文内容の確認
    - 注文内容の記録
    - 受注の通知
- データクラス
  - 注文データ
    - 商品
    - 数量
    - 届け先

--

### 良くある呼び方

- Data Transfer Object（DTO）
- Entity クラス
- From クラス
- JavaBeans

※Java 界隈だと一般的

--

### Python だと？

- ちょっと考えてみる
- 注文登録をする機能を作る
- 引数である注文データはどういう型で渡される？

--

### dictionary

https://docs.python.org/ja/3/tutorial/datastructures.html

--

### よくある

- とりあえず dict に入れる
- 1 つの dict に色んなものが入っている
- 1 つの dict を使いまわす

--

### 困った事

- dict に何が入っているかわからない
- Key のタイポ
- 型がわからない

--

### なりがち

- 変更箇所を特定するために広い範囲を調べる
- 1 つの変更に対してあちこちの修正が必要
- 変更の副作用の確認が大変

--

### 理由

- 同じ業務ロジックがあちこちに重複して書かれる
- どこに業務ロジックが書いてあるか見通しが悪くなる

---

## データクラスを使うと同じロジックがあちこちに重複する

--

### これはそのまま

- データを同じように処理したい箇所が複数にあれば処理は重複する

※流石に詳細は割愛

---

## 共通ライブラリが失敗する理由

--

### 共通ロジックは 1 つに共通化すれば良いのでは？

- common や util

--

### 微妙に異なる事が多い

- 共通関数であっても完全に同じでない事はよくある
- フィルタリングしたい
- Key が異なる
- ユニークではない
- などなど

--

### 汎用的な共通関数パターン

- 引数にフラグやオプションを追加
- ↑ を理解するのが困難
- 結局どれを設定すれば良いかわからない
- 使われない
- 同じようなロジックがあちこちに書かれる

--

### 用途毎に細分化された共通化関数パターン

- 数が多すぎる
- 違いがわからない
- 使われない
- 同じようなロジックがあちこちに書かれる

--

### 個人的な思い

- util にある事を知らない
- 自分から util を見に行かない
- util だけ見ても良くわからないので頭に残らない

---

## 第 3 章 業務ロジックをわかりやすく整理する

- データとロジックを別のクラスに分けることがわかりにくさを生む
- → **データとロジックを一体にして業務ロジックを整理する**
- 三層の関心毎と業務ロジックの分離を徹底する

---

## 業務ロジックを重複させないためにはどう設計すれば良いか

--

- データとロジックを 1 つのクラスにまとめる
- データは何らかの処理で使用するためにある
- データと処理を同じ場所に置いておくことで処理の重複がなくなる
  - 使う側に処理を書く必要がなくなるため
- → 使う側のコードがシンプルになる

--

### クラス設計で大雪な事

- **データを使う側のコードがシンプルになるように設計する事**

### 気をつける事

- メソッドをロジックの置き場所にする
- ロジックをデータを持つクラスに移動する
- 使う側のクラスにロジックを書き始めたら設計を見直す
- メソッドを短くしてロジックの移動をやりやすくする
- メソッドでは必ずインスタンス変数を使う
- クラスが肥大化したら小さく分ける
- パッケージを使ってクラスを整理する

---

## メソッドをロジックの置き場所にする

--

### dict -> dataclass

```python
xxx_param = {
  data_type = 'user_attribute',
  ...
}
```

```python
from dataclasses import dataclass
@dataclass
class XxxParam:
  data_type: str
```

--

### 使う側のコード

```python
xxx_param = XxxParam(data_type='user_attribute')
user_attribute_path = f's3://backet/{xxx_param.data_type}/'
user_attribute_df = spark.read.parquet(user_attribute_path)
```

※結局あちこちで同じコードが書かれる

--

### ロジックを書く

```python
from dataclasses import dataclass
@dataclass
class XxxParam:
  data_type: str

  @property
  def dataframe(self):
      return spark.read.parquet(f's3://backet/{self.data_type}/')
```

### 使う側のコード

```python
xxx_param = XxxParam(data_type='user_attribute')
user_attribute_df = xxx_param.dataframe
```

--

## これがオブジェクト

- インスタンス変数を使って加工や計算を行う
- インスタンス変数を返すだけでは意味が薄い

---

## 業務ロジックをデータを持つクラスに移動する

--

### データを持つ dict をクラス化する

- まずは dataclass に移行
- dict から脱却

--

### クラスに移す

- データを取得するという事はそれを使って処理をする
- その処理をクラスに移動する

--

### 移動すると？

- データを持つ側にロジックが増える
- データを使っていた側からロジックが減る
- 使う側はデータを取得するのではなく、処理結果を受け取るようになる

--

## さらに言うと

- データを持つクラスに業務ロジックを集めることが、コード重複や散在を防ぐオブジェクト指向の基本
- 集める事で重複がなくなる
- 重複がなくなると変更の対象個所をそのクラスに限定できる

---

## 使う側に業務ロジックを書き始めたら設計を見直す

--

---

以下未編集

### 現場で役立つシステム設計の原則

- 個人的にかなりの良本
- レベルアップを感じた
- 今良くわからなくても後で生きてくるはず

--

### 第 1 回について

- 今回はどこかで聞いたような内容
- 第 2 回以降が本番
- 基本大事。超大事。
- 時間の問題で質問や回答は別途

---

## なぜソフトウェアの変更は大変なのか

--

### あるある事項

- どこに何が書いてあるのかわからない
- 複数箇所の変更が必要
- 1 箇所修正したら別の箇所に影響がでる

--

## 設計に問題がある

--

### 直接関係はない事

- ドキュメントはしっかり整備されている
- コーディング規約に沿っている
- ユニットテストが書かれている

--

### 変更が大変なプログラムの特徴

- メソッド（関数）が長い
- クラスが大きい
- 引数が多い

--

## 変更するたびに変更が大変に

--

### 作成時

- メソッドは短い
- クラスは小さい
- 引数も少ない

--

### ちょっとした変更

- if 文 1 つと数行
- 変数 1 つとメソッド 1 つ
- 引数に 1 つ追加

--

### 結果

- 見通しが悪くなる
- 構造が入り組んでくる
- どこに何がかいてあるかわからなくなる

--

## 変更が大変なコード

- ちょっとした変更を繰り返したコード

--

## システム設計とは

変更に強いシステムを作る

--

変更するたびに変更が大変になる  
**「システム変更の負のスパイラル」**  
から抜け出す方法を学びます

---

## プログラムの変更が楽になる書き方

---

## わかりやすい名前を使う

--

### 名付けは重要

- 良い名前は一番大事
- 時間をかけて良い
- むしろ一番時間をかける所

--

### 悪い例

- 1 文字
  - d, i, x など
- 省略名
- 曖昧
  - data, array など

※例外はあるが迷うようなら使わない

--

### 理由

- 何を表しているのかわからない
- 良い名前を付けられないのは何かがおかしい
  - リファクタリングする指標
  - 設計や処理を見直す

--

### 同じ変数を使い回さない

- 適切な名前を付ける事で防げる
  - 同じ変数に入れることができないはず
- 処理後は処理済みとわかる名前を付ける
- 使い回さないことで影響範囲を局所化する

--

### ちょっと脱線

- なるべく immutable で作成する
  - 使いまわせなくなる
- 破壊的な関数は使用しない
  - list だと sort, append, pop など
- 汎用的な名前を避ける
  - 使いまわされがち
  - df, data など

---

## メソッドとして独立させる

--

### 基準

- この処理では何をするの？に対する答えをメソッド化する
- 行数が切り出す指標ではない
  - 1,2 行であっても切り出したほうが良い
  - 名前が付けられる

--

### step1: 処理を区切る

- コメントや空白行で区切りを付ける
- 人間にとっての読みやすさ向上
- プログラムの構造は変わっていない

--

### step2: メソッドとして独立

- コードがシンプルで読みやすくなる
- メソッド名からコードの意図が理解しやすい
- 切り出すことで独立した 1 つの部品になる
- 変更の影響をメソッドに閉じ込めやすい

--

### ちょっと脱線

- メソッド多くなって可読性悪いのでは？
  - → クラスとして抽出するタイミング
- `_` や `__` を有効活用
- メソッドの記載順も考慮
  - public, private の順が読みやすい

---

## 重複したコードをなくす

--

### ポイント

- 結果的に同じである処理に注意
- 本質的に重複しているかどうかが重要
- 本質的な処理、名称にする

--

### 手順

- メソッドとして独立させる
- 共通処理を探す
- 別クラスもしくは独立させたメソッドを呼びだすように変更

---

## 狭い関心事に特化したクラスにする

--

### ドメインオブジェクトを作る

- 業務で使われる用語をオブジェクトにする
- 翻訳が不要

--

### 特化する

- コードの見通しを良くする
- 変更をやりやすくする
- 余計な情報を持たない

--

### 既存コードの場合

- 細かく切り出したメソッドが多くなる
- それらの処理を何と呼ぶ？
- まとめてクラスにする

--

### 今後の勉強会では

ドメインオブジェクトを

- どのように作成するか
- どのように使うか
- どのように拡張するか

などを学びます

---

## メソッドは短くクラスは小さく

※まとめ

--

### 5 つのやり方

- 名前は普通の単語を使う
- 変数を使い回さない
- コードを意味のある単位で段落に分ける
- 段落をメソッドとして独立させる
- ドメインオブジェクトを作る

--

### 結果

- メソッド、クラス名から変更箇所を特定しやすい
- コードの重複がなくなる
- 変更の影響をメソッドやクラスに閉じ込めやすい

---

## 参考

- 現場で役立つシステム設計の原則
  - https://www.amazon.co.jp/dp/B073GSDBGT/
- 作者による本への質問や回答
  - https://www.slideshare.net/masuda220/ss-79304804
